<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店務管理系統</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">   
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        /* --- 【新增】租借視窗中已選遊戲標籤的樣式 --- */
        .selected-game-tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .remove-game-btn {
            background: none;
            border: none;
            color: white;
            margin-left: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
        }
        /* --- 行事曆樣式 --- */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }
        .calendar-header h3 { margin: 0; font-size: 1.2rem; }
        .calendar-header button { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }

        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid var(--border-color);
            background-color: white;
        }
        .calendar-day, .calendar-weekday {
            border-right: 1px solid var(--border-color);
            border-top: 1px solid var(--border-color);
            padding: 8px;
        }
        .calendar-day:nth-child(7n) { border-right: none; }
        .calendar-weekday {
            font-weight: bold;
            text-align: center;
            background-color: var(--light-gray);
        }
        .calendar-day {
            min-height: 120px;
            display: flex;
            flex-direction: column;
        }
        .day-number { font-weight: bold; }
        .day-other-month .day-number { color: #ccc; }
        .calendar-booking {
            font-size: 0.8rem;
            padding: 5px;
            margin-top: 5px;
            border-radius: 4px;
            background-color: var(--info-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s, opacity 0.3s; /* 新增過渡效果 */
        }
        .calendar-booking.status-checked-in {
            background-color: var(--secondary-color);
            opacity: 0.7;
        }
        .calendar-booking.status-cancelled {
            background-color: var(--danger-color);
            opacity: 0.6;
            text-decoration: line-through;
        }
        .calendar-booking-info {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-booking-actions button {
            padding: 2px 5px;
            font-size: 0.7rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: #333;
        }
        .calendar-booking-actions .btn-check-in {
            background-color: var(--success-color);
            color: white;
        }
        .calendar-booking-actions .btn-cancel-booking {
            background-color: var(--danger-color);
            color: white;
        }
        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
            .profile-summary {
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 1rem;
            }
        }
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --danger-color: #dc3545;
            --success-color: #28a745; --warning-color: #ffc107; --info-color: #17a2b8;
            --light-gray: #f8f9fa; --border-color: #dee2e6;
            --text-dark: #343a40; --text-light: #6c757d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--light-gray); }
        .header { background-color: var(--text-dark); color: white; padding: 0.8rem 1.5rem; }
        .header h1 { margin: 0; font-size: 1.4rem; }
        .nav-tabs { background-color: white; padding: 0 1rem; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: nowrap; overflow-x: auto; }
        .nav-tabs a { padding: 0.8rem; color: var(--text-light); text-decoration: none; font-weight: 500; border-bottom: 3px solid transparent; cursor: pointer; white-space: nowrap; }
        .nav-tabs a.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .main-content { padding: 1.5rem; }
        .page { display: none; } .page.active { display: block; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-header h2 { margin: 0; font-size: 1.8rem; color: var(--text-dark); }
        
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        th, td { padding: 0.8rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; text-align: center; }
        th { background-color: var(--light-gray); font-weight: 600; font-size: 0.9rem; }
        td { font-size: 0.9rem; }
        
        .compound-cell .main-info { font-weight: bold; }
        .compound-cell .sub-info { font-size: 0.8rem; color: var(--text-light); }
        .action-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-edit { background-color: var(--warning-color); color: #212529; }
        .btn-sync { background-color: var(--info-color); }
        .filter-bar { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; align-items: center; }
        .filter-group { display: flex; gap: 0.5rem; }
        .filter-group button { padding: 0.4rem 0.8rem; font-size: 0.8rem; border: 1px solid var(--border-color); background-color: white; border-radius: 5px; cursor: pointer; }
        .filter-group button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-start; z-index: 1000; overflow-y: auto; padding-top: 5vh; padding-bottom: 5vh; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; }
        .modal-close { font-size: 1.5rem; font-weight: bold; border: none; background: none; cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-actions { margin-top: 20px; text-align: right; }
        .btn-save { background-color: var(--primary-color); }
        .btn-cancel { background-color: var(--secondary-color); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .stat-card { background-color: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card h3 { margin-top: 0; color: var(--text-light); font-size: 1rem; }
        .stat-card .stat-value { font-size: 2.5rem; font-weight: bold; color: var(--primary-color); }
        .stat-card .stat-subtext { color: var(--text-light); font-size: 0.9rem; margin-top: 5px;}
        #user-details-modal .modal-content {
            max-width: 800px;
        }
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
        }
        .profile-summary {
            text-align: left;
            word-break: break-all;
        }
        .profile-details {
             /* 【新增】確保 profile-details 容器內容從頂部開始對齊 */
             align-content: flex-start; 
        } 
.crm-notes-section {
    margin-top: 0; /* 確保沒有上邊距推擠 */
    /* ... other crm-notes-section styles ... */
    align-self: start; /* 保留之前的嘗試 */
}

.crm-notes-section h4 {
    margin-top: 0; /* 確保標題也沒有上邊距 */
    margin-bottom: 3px; /* 【新增】減少標題和內容的間距 */
     /* ... other h4 styles ... */
}

.crm-notes-section p {
    margin-top: 0; /* 再次確保 p 也沒有上邊距 */
     /* ... other p styles ... */
}        
        

        .profile-summary img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 0.5rem;
            display: block;
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
        }
        .profile-summary h4 { margin: 0.2rem 0; }
        .profile-summary p {
            margin: 0.15rem 0;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .profile-summary hr { margin: 0.5rem 0; }
        .details-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
        }
        .details-tab {
            padding: 0.5rem 0.8rem;
            cursor: pointer;
        }
        .details-tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }
        .details-tab-content { display: none; }
        .details-tab-content.active {
            display: block;
            max-height: 220px;
            overflow-y: auto;
        }
        #user-details-modal table { font-size: 0.8rem; }
        #user-details-modal th, #user-details-modal td { padding: 0.4rem; }
        .message-sender {
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }
        .draggable-row { cursor: default; }
        .drag-handle-cell { text-align: left !important; }
        .drag-handle { cursor: move; display: inline-block; width: 20px; font-size: 1.2rem; color: #999; margin-right: 5px; }
        #edit-game-modal .modal-content { max-width: 800px; }
        .edit-game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-span-2 { grid-column: span 2; }
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .sub-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        @media (max-width: 768px) {
            .details-grid, .edit-game-grid, .sub-grid, .sub-grid-3 {
                grid-template-columns: 1fr;
            }
            .grid-span-2 { grid-column: span 1; }
            .profile-summary { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 8px;
            width: 90%; max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        #edit-game-form {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-grow: 1;
        }
        .modal-body {
            overflow-y: auto;
            padding-right: 15px;
        }
        .modal-header, .form-actions {
            flex-shrink: 0;
        }
        .form-actions {
            margin-top: 20px;
            text-align: right;
            flex-shrink: 0;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        #batch-toolbar {
            display: none;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        #batch-toolbar.visible {
            display: flex;
        }
        #batch-toolbar span {
            font-weight: bold;
        }
        #batch-toolbar .batch-actions button {
            margin-right: 0.5rem;
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .table-row-selected {
            background-color: #fffbe6 !important;
        }
        #batch-actions-toolbar button {
            margin-right: 8px;
        }
            /* 【新增】日曆上取消按鈕的樣式 */
    .calendar-cancel-btn {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(255, 255, 255, 0.7);
        color: var(--danger-color);
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        display: none; /* 預設隱藏 */
    }
    .calendar-booking:hover .calendar-cancel-btn {
        display: block; /* 滑鼠移上去時顯示 */
    }
    #edit-user-form {
        overflow-y: auto;   /* 內容過長時顯示垂直滾動條 */
        flex: 1;            /* 讓表單自動填滿 modal 剩餘空間 */
        padding-right: 5px; /* 避免滾動條遮擋住輸入框最右邊 */
        
        /* 確保表單在 flex 容器中能正確計算高度 */
        display: flex;      
        flex-direction: column;
    }

    /* 讓按鈕區域保持在底部 (選擇性，若想讓按鈕跟著滾動則不需要這行) */
    /* 若加上這行，中間內容滾動時，儲存按鈕會固定在底部 */
    #edit-user-form .form-actions {
        margin-top: auto;
        padding-top: 20px;
        padding-bottom: 10px; /* 預留底部空間 */
    }
    </style>
</head>
<body>
    <div id="admin-panel" style="display: none;">
        <header class="header">
            <h1>店務管理系統</h1>
        </header>
        <nav class="nav-tabs">
            <a href="#dashboard" class="active">儀表板</a>
            <a href="#users">顧客管理</a>
            <a href="#inventory">庫存管理</a>
            <a href="#rentals">桌遊租借</a>
            <a href="#bookings">訂位管理</a>
            <a href="#exp-history">經驗紀錄</a>
            <a href="#news">情報管理</a>
            <a href="#drafts">訊息草稿</a>
            <a href="#store-info">店家資訊</a>
            <a href="#scan">掃碼加點</a>
        </nav>
    
<main class="main-content">
        <div id="page-dashboard" class="page active">
        <div class="page-header">
            <h2>今日狀態總覽</h2>
            </div>
        <div id="dashboard-grid" class="dashboard-grid">
                <div class="stat-card" data-target="bookings">
                    <h3>今日預約總人數</h3>
                    <p id="stat-today-guests" class="stat-value">讀取中...</p>
                </div>
                <div class="stat-card" data-target="rentals-rented">
                    <h3>未歸還遊戲總數</h3>
                    <p id="stat-outstanding-rentals" class="stat-value">讀取中...</p>
                </div>
                <div class="stat-card" data-target="rentals-due-today">
                    <h3>今日到期遊戲</h3>
                    <p id="stat-due-today" class="stat-value">讀取中...</p>
                    <p class="stat-subtext">筆租借紀錄</p>
                </div>
        </div>

<div id="activity-feed-section" style="margin-top: 2rem;">
    <h2 class="page-header" style="justify-content: flex-start; gap: 1rem; align-items: center;">
        <span>最新動態</span>
        <span id="activity-count-badge" style="font-size: 0.9rem; background-color: var(--primary-color); color: white; padding: 4px 10px; border-radius: 12px; display: none;"></span>
    </h2>
    <div id="activity-feed-container" style="max-height: 400px; overflow-y: auto; background-color: var(--color-sidebar-bg); padding: 1rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
        <p>正在載入動態...</p>
    </div>
</div>                
            
        </div>

<div id="page-users" class="page">
    <div class="page-header">
        <h2>顧客管理</h2>
    </div>

    <div class="sub-nav-tabs">
        <button class="sub-tab-btn active" data-target="view-user-list">顧客總表</button>
        <button class="sub-tab-btn" data-target="view-membership-settings">會員制度設定</button>
    </div>

    <div id="view-user-list" class="sub-view-container">
        <input type="text" id="user-search-input" placeholder="搜尋 LINE / 暱稱 / 真實姓名 / 職業 / 標籤..." style="width: 100%; box-sizing: border-box; padding: 8px; margin-bottom: 1rem;">
        <table>
            <thead>
                <tr><th>LINE 名稱 / 暱稱</th><th>等級</th><th>經驗值</th><th>職業</th><th>標籤</th><th>操作</th></tr>
            </thead>
            <tbody id="user-list-tbody"></tbody>
        </table>
    </div>

    <div id="view-membership-settings" class="sub-view-container" style="display: none;">
        <div class="filter-bar" style="margin-top: 15px;">
            <div id="assets-type-filter" class="filter-group">
                <button class="active" data-type="class">職業管理</button>
                <button data-type="skill">技能管理</button>
                <button data-type="equipment">裝備管理</button>
            </div>
            <button id="btn-add-asset" class="action-btn btn-save" style="margin-left: auto;">新增項目</button>
        </div>

        <table style="margin-top: 10px;">
            <thead>
                <tr>
                    <th>名稱</th>
                    <th id="asset-desc-header">福利 / 說明</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="assets-list-tbody"></tbody>
        </table>
    </div>
</div>

<div id="page-inventory" class="page">
    <div class="page-header">
        <h2>庫存管理</h2>
        <div>
            <button id="btn-download-csv-template" class="action-btn" style="background-color: var(--info-color);">下載 CSV 模板</button>
            <button id="btn-import-csv" class="action-btn" style="background-color: var(--success-color);">從 CSV 匯入</button>
            <button id="btn-add-new-product" class="action-btn btn-save" style="margin-left: 10px;">新增單筆產品</button>
        </div>
    </div>
    <div class="filter-bar">
        <input type="text" id="game-search-input" placeholder="依桌遊名稱搜尋..." style="flex-grow: 1; padding: 8px;">
        <div id="inventory-stock-filter" class="filter-group">
            <button class="active" data-filter="all">全部庫存</button>
            <button data-filter="in_stock">有庫存</button>
            <button data-filter="out_of_stock">無庫存</button>
        </div>
        <div id="inventory-visibility-filter" class="filter-group">
            <button class="active" data-filter="all">全部狀態</button>
            <button data-filter="visible">已上架</button>
            <button data-filter="hidden">未上架</button>
        </div>
    </div>

    <div id="batch-actions-toolbar" style="display: none; background-color: #e9ecef; padding: 10px; margin-bottom: 1rem; border-radius: 8px;">
        <span id="batch-selection-count" style="margin-right: 15px; font-weight: bold;"></span>
        <button id="batch-publish-btn" class="action-btn" style="background-color: var(--success-color);">批次上架</button>
        <button id="batch-unpublish-btn" class="action-btn" style="background-color: var(--secondary-color);">批次下架</button>
    </div>
    <table>
        <thead>
            <tr>
                <th style="width: 20px;"><input type="checkbox" id="select-all-games-checkbox"></th>
                <th style="width: 50px;">順序</th>
                <th>遊戲 (ID / 標籤)</th>
                <th>總庫存</th>
                <th>租借庫存</th>
                <th>售價 / 租金</th>
                <th>上架</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="game-list-tbody"></tbody>
    </table>
</div>

        <div id="page-rentals" class="page">
            <div class="page-header">
                <h2>桌遊租借總表</h2>
            </div>
            <div class="filter-bar">
                <input type="text" id="rental-search-input" placeholder="依遊戲或會員名稱搜尋..." style="flex-grow: 1; padding: 8px;">
                <div id="rental-status-filter" class="filter-group">
                    <button class="active" data-filter="all">全部顯示</button>
                    <button data-filter="rented">租借中</button>
                    <button data-filter="overdue" style="color: var(--danger-color); font-weight: bold;">逾期未歸還</button>
                    <button data-filter="due_today">今日到期</button>
                    <button data-filter="returned">已歸還</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>狀態</th>
                        <th>遊戲名稱</th>
                        <th>租借人</th>
                        <th id="sort-due-date" class="sortable">應還日期</th>
                        <th>實際歸還日期</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="rental-list-tbody"></tbody>
            </table>
        </div>

<div id="create-rental-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>建立租借紀錄</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="create-rental-form">
            <input type="hidden" id="rental-user-id">
            
            <div class="form-group">
                <label for="rental-user-search">搜尋租借會員 (姓名/暱稱/ID)</label>
                <input type="text" id="rental-user-search" placeholder="輸入關鍵字搜尋會員，或直接填寫下方姓名登記為散客">
                <ul id="user-search-results" style="display: none; border: 1px solid #ccc; list-style: none; padding: 0; margin-top: 5px; max-height: 150px; overflow-y: auto; cursor: pointer;"></ul>
            </div>
            
            <div class="form-group">
                <label>租借品項 (可多選)</label>
                <div id="rental-games-container" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 5px;">
                    </div>
                <input type="text" id="rental-game-search" placeholder="輸入遊戲名稱搜尋...">
                <ul id="game-search-results" style="display: none; border: 1px solid #ccc; list-style: none; padding: 0; margin-top: 5px; max-height: 150px; overflow-y: auto; cursor: pointer;"></ul>
            </div>
            
            <div class="form-group">
                <label for="rental-contact-name">租借人姓名</label>
                <input type="text" id="rental-contact-name" required>
            </div>
            
            <div class="form-group">
                <label for="rental-contact-phone">聯絡電話 (選填)</label>
                <input type="tel" id="rental-contact-phone" maxlength="10">
            </div>
            
            <div class="form-group">
                <label for="rental-due-date">歸還日期</label>
                <input type="text" id="rental-due-date" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="rental-rent-price">租金</label>
                    <input type="number" id="rental-rent-price" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="rental-deposit">押金</label>
                    <input type="number" id="rental-deposit" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="rental-late-fee">每日逾期費</label>
                    <input type="number" id="rental-late-fee" value="50" min="0">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="action-btn btn-cancel">取消</button>
                <button type="submit" class="action-btn btn-save">確認租借</button>
            </div>
        </form>
    </div>
</div>

<div id="page-bookings" class="page">
    <div class="page-header">
        <h2>訂位管理</h2>
        <div>
            <button id="switch-to-calendar-view-btn" class="action-btn" style="background-color: var(--info-color); margin-right: 10px;">切換至行事曆</button>
            <button id="create-booking-btn" class="action-btn btn-save" style="margin-right: 10px;">手動建立預約</button>
            <button id="manage-booking-dates-btn" class="action-btn" style="background-color: #ffc107; color: #000;">管理公休日</button>
        </div>
    </div>

    <div id="calendar-view-container" style="display: none;">
        <div class="calendar-header">
            <button id="calendar-prev-month-btn">&lt;</button>
            <h3 id="calendar-month-year"></h3>
            <button id="calendar-next-month-btn">&gt;</button>
        </div>
        <div id="calendar-grid"></div>
    </div>

    <div id="list-view-container">
        <div class="filter-bar">
            <div id="booking-status-filter" class="filter-group">
                <button class="active" data-filter="today">今日預約</button>
                <button data-filter="confirmed">未來預約</button>
                <button data-filter="checked-in">已報到</button>
                <button data-filter="cancelled">已取消</button>
            </div>
        </div>
        <table>
            <thead>
                <tr><th>時間</th><th>客戶</th><th>人數</th><th>狀態</th><th>操作</th></tr>
            </thead>
            <tbody id="booking-list-tbody"></tbody>
        </table>
    </div>
</div>
        <div id="page-exp-history" class="page">
            <div class="page-header">
                <h2>經驗紀錄查詢</h2>
            </div>
            <div class="filter-bar">
                <input type="search" id="exp-user-filter-input" placeholder="依使用者名稱或 LINE ID 搜尋..." style="width: 100%; box-sizing: border-box; padding: 8px;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>使用者</th>
                        <th>日期</th>
                        <th>原因</th>
                        <th>經驗值</th>
                    </tr>
                </thead>
                <tbody id="exp-history-tbody"></tbody>
            </table>
        </div>
        <div id="page-news" class="page">
            <div class="page-header">
                <h2>情報管理</h2>
                <button id="add-news-btn" class="action-btn btn-save">新增情報</button>
            </div>
            <table>
                <thead>
                    <tr><th>標題</th><th>分類</th><th>發布日期</th><th>狀態</th><th>操作</th></tr>
                </thead>
                <tbody id="news-list-tbody"></tbody>
            </table>
        </div>
        <div id="page-drafts" class="page">
            <div class="page-header">
                <h2>訊息草稿管理</h2>
                <button id="add-draft-btn" class="action-btn btn-save">新增草稿</button>
            </div>
            <table>
                <thead>
                    <tr><th>標題</th><th>內容預覽</th><th>操作</th></tr>
                </thead>
                <tbody id="draft-list-tbody"></tbody>
            </table>
        </div>


        <div id="page-store-info" class="page">
            <div class="page-header"><h2>店家資訊管理</h2></div>
            <form id="store-info-form">
                <div class="form-group"><label for="info-address">地址</label><input type="text" id="info-address" required></div>
                <div class="form-group"><label for="info-phone">電話</label><input type="text" id="info-phone" required></div>
                <div class="form-group"><label for="info-hours">營業時間 (換行請直接按 Enter)</label><textarea id="info-hours" rows="5" required></textarea></div>
                <div class="form-group"><label for="info-desc">公會介紹</label><textarea id="info-desc" rows="8" required></textarea></div>
                
<hr style="border-color: var(--border-color); margin: 30px 0;">
<h3 style="text-align: center; color: var(--text-light);">預約頁面文字設定</h3>
<div class="form-group">
    <label for="info-booking-announcement">預約頁公告 (支援換行)</label>
    <textarea id="info-booking-announcement" rows="4" required></textarea>
</div>
<div class="form-group">
    <label for="info-booking-button">預約按鈕文字</label>
    <textarea id="info-booking-button" rows="2" required></textarea>
</div>
<div class="form-group">
    <label for="info-booking-promo">優惠文字</label>
    <textarea id="info-booking-promo" rows="2" required></textarea>
</div>           
                
                
                <div class="form-actions"><button type="submit" class="action-btn btn-save">儲存變更</button></div>
            </form>
        </div>

<div id="page-scan" class="page">
    <div class="page-header"><h2>掃碼加點</h2></div>
    <div id="scan-container">
        <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
        <div id="scan-result" style="display: none; max-width: 500px; margin: 0 auto;">
            
            <div class="form-group">
                <label for="scan-user-search">搜尋會員 (姓名/暱稱/ID)</label>
                <input type="text" id="scan-user-search" placeholder="或手動搜尋會員...">
                <ul id="scan-user-search-results" style="display: none; border: 1px solid #ccc; list-style: none; padding: 0; margin-top: 5px; max-height: 150px; overflow-y: auto; cursor: pointer; z-index: 10;"></ul>
            </div>
            
            <div class="form-group">
                <label for="user-id-display">目標使用者 ID:</label>
                <input type="text" id="user-id-display" readonly style="background-color: #e9ecef; cursor: not-allowed;">
            </div>
            
            <div class="form-group">
                <label for="reason-select">新增原因</label>
                <select id="reason-select">
                    <option value="消費回饋">消費回饋 (預設)</option>
                    <option value="參與活動">參與活動</option>
                    <option value="其他">其他 (自訂)</option>
                </select>
                <input type="text" id="custom-reason-input" placeholder="請輸入自訂原因" style="display: none; margin-top: 10px;">
            </div>
            
            <div class="form-group">
                <label for="exp-input">經驗值點數</label>
                <input type="number" id="exp-input" value="2" min="1" max="1000" required>
            </div>
            
            <div id="scan-status-container" style="color: red; margin-bottom: 10px;"></div>

            <div class="form-actions" style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button id="rescan-btn" type="button" class="action-btn btn-cancel" style="flex-grow: 1; margin-right: 10px;">重新掃描/手動輸入</button>
                <button id="submit-exp-btn" type="button" class="action-btn btn-save" style="flex-grow: 1;">確認新增</button>
            </div>
            </div>
    </div>
</div>
    </main>

<div id="booking-details-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="booking-details-title">訂位詳細資訊</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div id="booking-details-content">
            </div>
    </div>
</div>    

<div id="booking-settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>管理可預約日 (可複選)</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div id="booking-datepicker-admin-container"></div>
        <div class="form-actions">
            <button type="button" id="open-month-btn" class="action-btn" style="background-color: var(--info-color); float: left;">開啟本月所有日期</button>
            <button type="button" class="action-btn btn-cancel">取消</button>
            <button type="button" id="save-booking-settings-btn" class="action-btn btn-save">儲存變更</button>
        </div>
    </div>
</div>

<div id="user-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="user-details-title">顧客資料</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div id="user-details-content">
                </div>
        </div>
    </div>
    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-user-title">編輯使用者</h3>
                <button class="modal-close">&times;</button>
            </div>
<form id="edit-user-form">
    <input type="hidden" id="edit-user-id">
    
    <div class="sub-grid">
        <div class="form-group"><label>等級</label><input type="number" id="edit-level-input" min="1"></div>
        <div class="form-group"><label>經驗值</label><input type="number" id="edit-exp-input" min="0"></div>
    </div>

    <div class="form-group">
        <label>職業 (Class)</label>
        <select id="edit-class-select"></select>
        <input type="text" id="edit-class-other-input" placeholder="自訂職業" style="display:none; margin-top:5px;">
    </div>
    <div class="form-group">
        <label>職業福利 (Perk)</label>
        <input type="text" id="edit-perk-input" placeholder="對應職業的福利內容">
    </div>
    
    <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">

    <div class="form-group">
        <label>技能 (Skill)</label>
        <select id="edit-skill-select"></select>
        <input type="text" id="edit-skill-other-input" placeholder="自訂技能" style="display:none; margin-top:5px;">
    </div>
    <div class="form-group">
        <label>技能說明 (Description)</label>
        <textarea id="edit-skill-desc-input" rows="2" placeholder="技能的效果說明"></textarea>
    </div>

    <div class="form-group">
        <label>裝備 (Equipment)</label>
        <select id="edit-equipment-select"></select>
        <input type="text" id="edit-equipment-other-input" placeholder="自訂裝備" style="display:none; margin-top:5px;">
    </div>

    <div class="form-group">
        <label>標籤</label>
        <select id="edit-tag-select"></select>
        <input type="text" id="edit-tag-other-input" style="display:none; margin-top:5px;">
    </div>
    
    <div class="form-group">
        <label>備註</label>
        <textarea id="edit-notes-textarea" rows="3"></textarea>
    </div>

    <div class="form-actions">
        <button type="button" class="action-btn btn-cancel">取消</button>
        <button type="submit" class="action-btn btn-save">儲存</button>
    </div>
</form>

        </div>
    </div>

    <div id="edit-news-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-news-title">新增情報</h3><button class="modal-close">&times;</button></div>
            <form id="edit-news-form">
                <input type="hidden" id="edit-news-id">
                <div class="form-group"><label for="edit-news-title">標題</label><input type="text" id="edit-news-title" required></div>
                <div class="form-group"><label for="edit-news-category">分類</label><input type="text" id="edit-news-category" placeholder="例如：促銷活動" required></div>
                <div class="form-group"><label for="edit-news-date">發布日期</label><input type="text" id="edit-news-date" required></div>
                <div class="form-group"><label for="edit-news-image">圖片網址</label><input type="url" id="edit-news-image" placeholder="https://..."></div>
                <div class="form-group"><label for="edit-news-content">詳細內文 (選填)</label><textarea id="edit-news-content" rows="8"></textarea></div>
                <div class="form-group"><label style="display: flex; align-items: center;"><input type="checkbox" id="edit-news-published" checked style="width: auto; margin-right: 10px;">立即發布</label></div>
                <div class="form-actions">
                    <button type="button" class="action-btn btn-cancel">取消</button>
                    <button type="submit" class="action-btn btn-save">儲存</button>
                    <button type="button" id="delete-news-btn" class="action-btn" style="display: none; background-color: #dc3545;">刪除</button>
                </div>
            </form>
        </div>
    </div>

<div id="create-rental-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>建立租借紀錄</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="create-rental-form">
            <input type="hidden" id="rental-user-id">
            
            <div class="form-group">
                <label for="rental-user-search">搜尋租借會員 (姓名/暱稱/ID)</label>
                <input type="text" id="rental-user-search" placeholder="輸入關鍵字搜尋會員，或直接填寫下方姓名登記為散客">
                <ul id="user-search-results" style="display: none; border: 1px solid #ccc; list-style: none; padding: 0; margin-top: 5px; max-height: 150px; overflow-y: auto; cursor: pointer;"></ul>
            </div>
            
            <div class="form-group">
                <label>租借品項 (可多選)</label>
                <div id="rental-games-container" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 5px;">
                    </div>
                <input type="text" id="rental-game-search" placeholder="輸入遊戲名稱搜尋...">
                <ul id="game-search-results" style="display: none; border: 1px solid #ccc; list-style: none; padding: 0; margin-top: 5px; max-height: 150px; overflow-y: auto; cursor: pointer;"></ul>
            </div>
            
            <div class="form-group">
                <label for="rental-contact-name">租借人姓名</label>
                <input type="text" id="rental-contact-name" required>
            </div>
            
            <div class="form-group">
                <label for="rental-contact-phone">聯絡電話 (選填)</label>
                <input type="tel" id="rental-contact-phone" maxlength="10">
            </div>
            
            <div class="form-group">
                <label for="rental-due-date">歸還日期</label>
                <input type="text" id="rental-due-date" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label for="rental-rent-price">租金</label>
                    <input type="number" id="rental-rent-price" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="rental-deposit">押金</label>
                    <input type="number" id="rental-deposit" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="rental-late-fee">每日逾期費</label>
                    <input type="number" id="rental-late-fee" value="50" min="0">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="action-btn btn-cancel">取消</button>
                <button type="submit" class="action-btn btn-save">確認租借</button>
            </div>
        </form>
    </div>
</div>
 
       <div id="cancel-booking-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>取消預約並發送通知</h3>
                <button class="modal-close">&times;</button>
            </div>
            <p>您正準備取消 <strong id="cancel-booking-info"></strong> 的預約。</p>
            <div class="message-sender">
                <div class="form-group">
                    <label for="cancel-message-draft-select">選擇通知訊息草稿 (選填)</label>
                    <select id="cancel-message-draft-select"><option value="">-- 不發送通知或手動輸入 --</option></select>
                </div>
                <div class="form-group">
                    <label for="cancel-direct-message-content">訊息內容</label>
                    <textarea id="cancel-direct-message-content" rows="4" placeholder="若留空，則只取消預約，不發送通知。"></textarea>
                </div>
                <div class="form-actions">
                    <button id="confirm-cancel-booking-btn" class="action-btn btn-save">確認取消</button>
                </div>
            </div>
        </div>
    </div> 

    <div id="edit-game-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="modal-game-title">編輯遊戲</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="edit-game-form">
                <div class="modal-body">
                    <input type="hidden" id="edit-game-id">
                    <div class="edit-game-grid">
                        
                        <div>
                            <div class="form-group">
                                <label for="edit-game-name">遊戲名稱</label>
                                <input type="text" id="edit-game-name" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-game-id-display">遊戲 ID (不可修改)</label>
                                <input type="text" id="edit-game-id-display" readonly style="background: #e9ecef;">
                            </div>
                            <div class="form-group">
                                <label for="edit-game-tags">標籤 (以逗號分隔)</label>
                                <input type="text" id="edit-game-tags">
                            </div>
                            <div class="form-group">
                                <label for="edit-game-image">主要圖片網址</label>
                                <input type="url" id="edit-game-image" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label for="edit-game-image-2">圖片網址 2 (選填)</label>
                                <input type="url" id="edit-game-image-2" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label for="edit-game-image-3">圖片網址 3 (選填)</label>
                                <input type="url" id="edit-game-image-3" placeholder="https://...">
                            </div>
                        </div>

                        <div>
                            <div class="sub-grid-3">
                                <div class="form-group"><label for="edit-min-players">最少人數</label><input type="number" id="edit-min-players" min="1"></div>
                                <div class="form-group"><label for="edit-max-players">最多人數</label><input type="number" id="edit-max-players" min="1"></div>
                                <div class="form-group"><label for="edit-difficulty">難度</label><select id="edit-difficulty"><option>簡單</option><option>普通</option><option>困難</option><option>專家</option></select></div>
                            </div>
                            <div class="sub-grid">
                                <div class="form-group"><label for="edit-total-stock">總庫存</label><input type="number" id="edit-total-stock" min="0"></div>
                                <div class="form-group"><label for="edit-for-rent-stock">可租借庫存</label><input type="number" id="edit-for-rent-stock" min="0"></div>
                            </div>
                            <div class="sub-grid">
                                <div class="form-group"><label for="edit-sale-price">售價</label><input type="number" id="edit-sale-price" min="0"></div>
                                <div class="form-group"><label for="edit-rent-price">租金</label><input type="number" id="edit-rent-price" min="0"></div>
                            </div>
                             <div class="sub-grid">
                                <div class="form-group"><label for="edit-deposit">押金</label><input type="number" id="edit-deposit" min="0"></div>
                                <div class="form-group"><label for="edit-late-fee">每日逾期費</label><input type="number" id="edit-late-fee" min="0"></div>
                            </div>
                            <div class="form-group"><label style="display: flex; align-items: center; margin-top: 10px;"><input type="checkbox" id="edit-is-visible" style="width: auto; margin-right: 10px;">是否上架 (顯示於 LIFF)</label></div>
                        </div>

                        <div class="form-group grid-span-2">
                            <label for="edit-game-desc">遊戲介紹</label>
                            <textarea id="edit-game-desc" rows="4"></textarea>
                        </div>
                        <div class="form-group grid-span-2">
                            <label for="edit-supplementary-info">補充說明 (配件、注意事項等)</label>
                            <textarea id="edit-supplementary-info" rows="4"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="action-btn btn-cancel">取消</button>
                    <button type="submit" class="action-btn btn-save">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
<div id="edit-draft-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-draft-title">編輯訊息草稿</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="edit-draft-form">
            <input type="hidden" id="edit-draft-id">
            <div class="form-group">
                <label for="edit-draft-title">草稿標題</label>
                <input type="text" id="edit-draft-title" required placeholder="方便您辨識的標題，不會傳送給顧客">
            </div>
            <div class="form-group">
                <label for="edit-draft-content">訊息內容</label>
                <textarea id="edit-draft-content" rows="6" required placeholder="這是將會傳送給顧客的實際內容"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" id="delete-draft-btn" class="action-btn" style="display: none; background-color: var(--danger-color); float: left;">刪除</button>
                <button type="button" class="action-btn btn-cancel">取消</button>
                <button type="submit" class="action-btn btn-save">儲存草稿</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-rental-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-rental-title">管理租借紀錄</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="edit-rental-form">
            <input type="hidden" id="edit-rental-id">
            <div class="form-group">
                <label>系統計算逾期總額</label>
                <input type="text" id="calculated-late-fee-display" readonly style="background: #e9ecef; color: var(--danger-color); font-weight: bold;">
            </div>
            <div class="form-group">
                <label for="edit-rental-due-date">修改應還日期 (延期)</label>
                <input type="text" id="edit-rental-due-date">
            </div>
            <div class="form-group">
                <label for="edit-rental-override-fee">手動覆寫逾期金額 (選填)</label>
                <input type="number" id="edit-rental-override-fee" min="0" placeholder="留空則由系統自動計算">
            </div>
            <div class="form-actions">
                <button type="button" class="action-btn btn-cancel">取消</button>
                <button type="submit" class="action-btn btn-save">儲存變更</button>
            </div>
        </form>
        <div class="message-sender" style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
            <h4>發送 LINE 訊息</h4>
            <div class="form-group">
                <label for="rental-message-draft-select">選擇訊息草稿</label>
                <select id="rental-message-draft-select"><option value="">-- 手動輸入或選擇草稿 --</option></select>
            </div>
            <div class="form-group">
                <label for="rental-direct-message-content">訊息內容</label>
                <textarea id="rental-direct-message-content" rows="4"></textarea>
            </div>
            <div class="form-actions">
                <button id="rental-send-direct-message-btn" class="action-btn btn-save">確認發送</button>
            </div>
        </div>
    </div>
</div>
<div id="create-booking-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>手動建立預約</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="create-booking-form">
            <div class="form-group">
                <label for="booking-user-search">搜尋預約會員 (姓名/暱稱/ID)</label>
                <input type="text" id="booking-user-search" placeholder="輸入關鍵字搜尋，或留空以散客身分預約">
                <ul id="booking-user-search-results" style="display: none; border: 1px solid #ccc; list-style: none; padding: 0; margin-top: 5px; max-height: 150px; overflow-y: auto; cursor: pointer;"></ul>
                <input type="hidden" id="booking-user-id">
            </div>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <div class="sub-grid">
                <div class="form-group">
                    <label for="booking-date-input">預約日期</label>
                    <input type="text" id="booking-date-input" required>
                </div>
                <div class="form-group">
                    <label for="booking-slot-select">預約時段</label>
                    <select id="booking-slot-select" required></select>
                </div>
            </div>
            <div class="sub-grid">
                <div class="form-group">
                    <label for="booking-name-input">聯絡姓名</label>
                    <input type="text" id="booking-name-input" required>
                </div>
                 <div class="form-group">
                    <label for="booking-phone-input">聯絡電話</label>
                    <input type="tel" id="booking-phone-input" maxlength="10">
                </div>
            </div>
             <div class="sub-grid">
                <div class="form-group">
                    <label for="booking-people-input">人數</label>
                    <input type="number" id="booking-people-input" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label for="booking-item-input">預約項目 (選填)</label>
                    <input type="text" id="booking-item-input">
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="action-btn btn-cancel">取消</button>
                <button type="submit" class="action-btn btn-save">確認建立</button>
            </div>
        </form>
    </div>
</div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script type="module" src="admin/app.js"></script>
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>請確認</h3>
                <button class="modal-close">&times;</button>
            </div>
            <p id="confirmation-message" style="margin: 20px 0; line-height: 1.6;">這是確認訊息。</p>
            <div class="form-actions">
                <button type="button" id="confirmation-cancel-btn" class="action-btn btn-cancel">取消</button>
                <button type="button" id="confirmation-confirm-btn" class="action-btn btn-save">確認</button>
            </div>
        </div>
    </div>

<div id="import-csv-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>從 CSV 匯入遊戲</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="import-csv-form">
                <div class="form-group">
                    <label for="csv-file-input">選擇 .csv 檔案</label>
                    <input type="file" id="csv-file-input" accept=".csv" required>
                </div>
                <div class="form-group">
                    <p style="font-size: 0.9rem; color: var(--text-light);">
                        請確保 CSV 檔案的欄位標題與模板一致。<br>
                        - <b>遊戲ID (game_id)</b>: 留空會自動生成，填入既有 ID 則會更新該筆資料。<br>
                        - <b>是否上架</b>: 填入 TRUE 或 1 代表上架。
                    </p>
                </div>
                <div class="form-actions">
                    <button type="button" class="action-btn btn-cancel">取消</button>
                    <button type="submit" class="action-btn btn-save">開始匯入</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirmation-modal" class="modal-overlay">
        </div>

<div id="edit-asset-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-asset-title">編輯項目</h3>
            <button class="modal-close">&times;</button>
        </div>
        <form id="edit-asset-form">
            <input type="hidden" id="edit-asset-id">
            <input type="hidden" id="edit-asset-type">
            <div class="form-group">
                <label>項目名稱</label>
                <input type="text" id="edit-asset-name" required placeholder="例如：戰士、火球術、新手劍">
            </div>
            <div class="form-group">
                <label id="edit-asset-desc-label">內容說明</label>
                <textarea id="edit-asset-desc" rows="4" placeholder="輸入福利內容或技能說明..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="action-btn btn-cancel">取消</button>
                <button type="submit" class="action-btn btn-save">儲存</button>
                <button type="button" id="delete-asset-btn" class="action-btn" style="background-color: var(--danger-color); float: left; display: none;">刪除</button>
            </div>
        </form>
    </div>
</div>


</body>
</html>

    </body>
</html>